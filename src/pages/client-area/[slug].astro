---
import Layout from '@/layouts/Layout.astro';
import { dummyClientGalleries, getClientGalleryBySlug } from '@/lib/dummy-data';
import { formatDate } from '@/lib/utils';

export function getStaticPaths() {
  return dummyClientGalleries.map(gallery => ({
    params: { slug: gallery.slug },
    props: { gallery }
  }));
}

const { gallery } = Astro.props;
---

<Layout title={`${gallery.clientName} - ${gallery.eventName}`}>
  <section class="client-gallery" data-slug={gallery.slug}>
    <div class="container">
      <header class="gallery-header">
        <a href="/client-area" class="gallery-header__back">‚Üê Back to Client Area</a>
        <p class="subtle-text">{gallery.eventDate && formatDate(gallery.eventDate, 'd MMMM yyyy')}</p>
        <h1 class="section-heading">{gallery.eventName}</h1>
        <p class="gallery-header__client">For {gallery.clientName}</p>
        {gallery.message && <p class="gallery-header__message">{gallery.message}</p>}
      </header>

      <div class="gallery-actions">
        {gallery.downloadEnabled && (
          <button class="btn btn--primary" id="download-all">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
            Download All
          </button>
        )}
        <span class="photo-count">{gallery.photos?.length || 0} photos</span>
      </div>

      <div class="gallery-grid" id="client-gallery-grid">
        {gallery.photos?.map((photo, index) => (
          <div class="gallery-item" data-index={index}>
            <div class="gallery-item__image">
              <img src={photo.image} alt={photo.title} loading="lazy" />
              <div class="gallery-item__overlay">
                <button class="gallery-item__view" data-src={photo.image} data-title={photo.title}>
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>
                </button>
                {gallery.downloadEnabled && (
                  <a href={photo.image} download class="gallery-item__download">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                  </a>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>

      {gallery.expiresAt && (
        <p class="gallery-expiry">
          This gallery expires on {formatDate(gallery.expiresAt, 'd MMMM yyyy')}
        </p>
      )}
    </div>
  </section>
</Layout>

<style>
  .client-gallery { padding: 10rem 0 6rem; }
  .gallery-header { text-align: center; margin-bottom: 3rem; }
  .gallery-header__back { display: inline-block; font-size: 0.8125rem; color: #888; margin-bottom: 1.5rem; transition: color 0.2s; }
  .gallery-header__back:hover { color: #1a1a1a; }
  .gallery-header .subtle-text { margin-bottom: 0.5rem; }
  .gallery-header__client { font-size: 1.125rem; color: #666; margin-top: 0.5rem; }
  .gallery-header__message { max-width: 600px; margin: 1.5rem auto 0; padding: 1.5rem; background: #f8f8f8; border-radius: 8px; font-style: italic; color: #555; }
  .gallery-actions { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid #eee; }
  .photo-count { font-size: 0.875rem; color: #888; }
  .gallery-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
  .gallery-item { position: relative; overflow: hidden; border-radius: 4px; background: #f5f5f5; }
  .gallery-item__image { aspect-ratio: 1; position: relative; }
  .gallery-item__image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
  .gallery-item:hover img { transform: scale(1.05); }
  .gallery-item__overlay { position: absolute; inset: 0; background: rgba(0,0,0,0); display: flex; align-items: center; justify-content: center; gap: 0.75rem; transition: background 0.3s; }
  .gallery-item:hover .gallery-item__overlay { background: rgba(0,0,0,0.4); }
  .gallery-item__view, .gallery-item__download { width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.9); border: none; display: flex; align-items: center; justify-content: center; color: #1a1a1a; cursor: pointer; opacity: 0; transform: translateY(10px); transition: all 0.3s; }
  .gallery-item:hover .gallery-item__view, .gallery-item:hover .gallery-item__download { opacity: 1; transform: translateY(0); }
  .gallery-item__view:hover, .gallery-item__download:hover { background: #fff; }
  .gallery-expiry { text-align: center; margin-top: 3rem; font-size: 0.875rem; color: #888; }
  @media (max-width: 1024px) { .gallery-grid { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 768px) { .gallery-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 480px) { .client-gallery { padding: 8rem 0 4rem; } .gallery-grid { grid-template-columns: 1fr; } }
</style>

<script>
  // Check access
  const gallerySection = document.querySelector('.client-gallery') as HTMLElement;
  const slug = gallerySection?.dataset.slug;
  
  if (slug && !sessionStorage.getItem('client_access_' + slug)) {
    window.location.href = '/client-area';
  }

  // Lightbox functionality
  const viewButtons = document.querySelectorAll('.gallery-item__view');
  const images = Array.from(viewButtons).map(btn => ({
    src: (btn as HTMLElement).dataset.src || '',
    title: (btn as HTMLElement).dataset.title || ''
  }));

  viewButtons.forEach((btn, index) => {
    btn.addEventListener('click', () => {
      if (typeof (window as any).openLightbox === 'function') {
        (window as any).openLightbox(images, index);
      }
    });
  });

  // Download all (demo)
  document.getElementById('download-all')?.addEventListener('click', () => {
    alert('In production, this would download all photos as a ZIP file.');
  });
</script>
